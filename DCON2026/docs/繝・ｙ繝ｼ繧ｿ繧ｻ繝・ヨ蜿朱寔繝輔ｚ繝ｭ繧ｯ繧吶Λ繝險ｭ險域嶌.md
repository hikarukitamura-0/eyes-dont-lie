# **ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆåé›†ãƒ—ãƒ­ã‚°ãƒ©ãƒ è¨­è¨ˆæ›¸**

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: Zone Key - Data Collection System  
ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.0  
ä½œæˆæ—¥: 2025-12-11

---

## **1. æ¦‚è¦**

æœ¬è¨­è¨ˆæ›¸ã¯ã€ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«ã®å­¦ç¿’ã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’åé›†ã™ã‚‹ãŸã‚ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®è¨­è¨ˆã‚’å®šç¾©ã™ã‚‹ã€‚ã‚­ãƒ¼ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ãƒ»ãƒ€ã‚¤ãƒŠãƒŸã‚¯ã‚¹ã€ãƒã‚¦ã‚¹å‹•ä½œã€ç’°å¢ƒãƒ‡ãƒ¼ã‚¿ã€ä½œæ¥­ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã—ã€ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã‚’ä¿è­·ã—ãªãŒã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã™ã‚‹ã€‚

### **1.1 ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“åƒ**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Zone Key ãƒ‡ãƒ¼ã‚¿åé›†ã‚·ã‚¹ãƒ†ãƒ                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ã‚­ãƒ¼ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯â”‚  â”‚ ãƒã‚¦ã‚¹å‹•ä½œ  â”‚  â”‚ ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦   â”‚        â”‚
â”‚  â”‚åé›†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«â”‚  â”‚åé›†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«â”‚  â”‚åé›†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚         â”‚                 â”‚                 â”‚                â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                  â”‚                                           â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚         â”‚  ãƒ‡ãƒ¼ã‚¿é›†ç´„      â”‚                                  â”‚
â”‚         â”‚  ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«      â”‚                                  â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                  â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚ ç’°å¢ƒãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«      â”‚                            â”‚
â”‚  â”‚ (M5Stack ENV III Unit)     â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                  â”‚                                           â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚         â”‚  å‰å‡¦ç†ãƒ»åŒ¿ååŒ–  â”‚                                  â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                  â”‚                                           â”‚
â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                  â”‚                      â”‚                    â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚         â”‚  ãƒ‡ãƒ¼ã‚¿ä¿å­˜      â”‚    â”‚  PVTãƒ†ã‚¹ãƒˆ     â”‚           â”‚
â”‚         â”‚ (SQLite DB)    â”‚â—„â”€â”€â”€â”¤  (é›†ä¸­åº¦æ¸¬å®š)  â”‚           â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                  ã€5åˆ†ã”ã¨ã€‘                â”‚
â”‚                                  åå¿œæ™‚é–“æ¸¬å®š â†’ é›†ä¸­åº¦ç®—å‡º   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## **2. ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ**

### **2.1 é–‹ç™ºç’°å¢ƒ**

| é …ç›®                   | å†…å®¹                                        |
| :--------------------- | :------------------------------------------ |
| **ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èª** | Python 3.9+                                 |
| **å¯¾å¿œ OS**            | Windows 10/11, macOS 12+                    |
| **å¿…è¦ãªãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢** | M5Stack ENV III Unit (æ¸©æ¹¿åº¦ãƒ»æ°—åœ§ã‚»ãƒ³ã‚µãƒ¼) |

### **2.2 ä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**

```python
# å…¥åŠ›ãƒ‡ãƒã‚¤ã‚¹åˆ¶å¾¡
pynput==1.7.6          # ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ»ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—
pygetwindow==0.0.9     # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦æƒ…å ±å–å¾—
psutil==5.9.5          # ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±å–å¾—

# ãƒ‡ãƒ¼ã‚¿å‡¦ç†
numpy==1.24.3
pandas==2.0.3

# ç’°å¢ƒã‚»ãƒ³ã‚µãƒ¼é€šä¿¡
pyserial==3.5          # M5Stackã¨ã®ã‚·ãƒªã‚¢ãƒ«é€šä¿¡

# ãƒ‡ãƒ¼ã‚¿ä¿å­˜
sqlite3 (æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒª)  # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

# æ™‚åˆ»å‡¦ç†
datetime (æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒª)
time (æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒª)

# ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
hashlib (æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒª)  # åŒ¿ååŒ–ç”¨
threading (æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒª) # ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰å‡¦ç†
```

---

## **3. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­è¨ˆ**

### **3.1 ã‚­ãƒ¼ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯åé›†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« (`keystroke_collector.py`)**

#### **3.1.1 åé›†ãƒ‡ãƒ¼ã‚¿**

```python
{
    "timestamp": "2025-12-11T14:30:45.123",  # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
    "key_interval_ms": 125,                   # æ‰“éµé–“éš”ï¼ˆãƒŸãƒªç§’ï¼‰
    "key_press_duration_ms": 78,              # ã‚­ãƒ¼æŠ¼ä¸‹æ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
    "is_backspace": false,                    # Backspace/Deleteã‚­ãƒ¼ã‹
    "is_modifier": false                      # Ctrl/Shiftç­‰ã®ä¿®é£¾ã‚­ãƒ¼ã‹
}
```

#### **3.1.2 å®Ÿè£…æ–¹é‡**

- **ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·**: ã‚­ãƒ¼ã®å†…å®¹ï¼ˆæ–‡å­—ï¼‰ã¯ä¸€åˆ‡å–å¾—ã—ãªã„
- **è¨˜éŒ²æƒ…å ±**: ã‚¿ã‚¤ãƒŸãƒ³ã‚°æƒ…å ±ï¼ˆé–“éš”ãƒ»æŠ¼ä¸‹æ™‚é–“ï¼‰ã®ã¿
- **ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‹•ä½œ**: pynput ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’ä½¿ç”¨

#### **3.1.3 å®Ÿè£…ã‚³ãƒ¼ãƒ‰ä¾‹**

```python
from pynput import keyboard
import time
from collections import deque

class KeystrokeCollector:
    def __init__(self):
        self.last_key_time = None
        self.key_events = deque(maxlen=1000)  # æœ€æ–°1000ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¿æŒ

    def on_press(self, key):
        current_time = time.time()
        key_data = {
            "timestamp": current_time,
            "event_type": "press",
            "is_backspace": key in [keyboard.Key.backspace, keyboard.Key.delete],
            "is_modifier": key in [keyboard.Key.ctrl, keyboard.Key.shift,
                                  keyboard.Key.alt, keyboard.Key.cmd]
        }

        # æ‰“éµé–“éš”ã®è¨ˆç®—
        if self.last_key_time is not None:
            key_data["key_interval_ms"] = (current_time - self.last_key_time) * 1000

        self.key_events.append(key_data)
        self.last_key_time = current_time

    def on_release(self, key):
        # Key Releaseæ™‚ã®å‡¦ç†ï¼ˆæŠ¼ä¸‹æ™‚é–“ã®è¨˜éŒ²ï¼‰
        pass

    def start(self):
        listener = keyboard.Listener(on_press=self.on_press, on_release=self.on_release)
        listener.start()
```

#### **3.1.4 é›†è¨ˆå‡¦ç†ï¼ˆ1 åˆ†ã”ã¨ï¼‰**

```python
def calculate_1min_stats(self):
    """1åˆ†é–“ã®ã‚­ãƒ¼ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯çµ±è¨ˆã‚’è¨ˆç®—"""
    recent_events = [e for e in self.key_events
                    if time.time() - e["timestamp"] <= 60]

    intervals = [e["key_interval_ms"] for e in recent_events
                if "key_interval_ms" in e]

    return {
        "typing_speed_kpm": len(recent_events),  # Keys Per Minute
        "avg_key_interval_ms": np.mean(intervals) if intervals else 0,
        "std_key_interval_ms": np.std(intervals) if intervals else 0,
        "max_key_interval_ms": max(intervals) if intervals else 0,
        "min_key_interval_ms": min(intervals) if intervals else 0,
        "mistype_frequency": sum(1 for e in recent_events if e["is_backspace"]),
        "timestamp": time.time()
    }
```

---

### **3.2 ãƒã‚¦ã‚¹å‹•ä½œåé›†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« (`mouse_collector.py`)**

#### **3.2.1 åé›†ãƒ‡ãƒ¼ã‚¿**

```python
{
    "timestamp": "2025-12-11T14:30:45.123",
    "mouse_x": 1024,                # Xåº§æ¨™ï¼ˆçµ¶å¯¾å€¤ã¯è¨˜éŒ²ã—ãªã„ï¼‰
    "mouse_y": 768,                 # Yåº§æ¨™ï¼ˆçµ¶å¯¾å€¤ã¯è¨˜éŒ²ã—ãªã„ï¼‰
    "movement_distance": 150.5,     # ç§»å‹•è·é›¢ï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰
    "click_type": "left"            # "left", "right", "double", null
}
```

#### **3.2.2 å®Ÿè£…ã‚³ãƒ¼ãƒ‰ä¾‹**

```python
from pynput import mouse
import math

class MouseCollector:
    def __init__(self):
        self.last_position = None
        self.total_distance = 0
        self.click_count = {"left": 0, "right": 0, "double": 0}
        self.still_time = 0
        self.last_move_time = time.time()

    def on_move(self, x, y):
        current_time = time.time()

        if self.last_position is not None:
            # ç§»å‹•è·é›¢ã®è¨ˆç®—
            distance = math.sqrt(
                (x - self.last_position[0])**2 +
                (y - self.last_position[1])**2
            )
            self.total_distance += distance

        self.last_position = (x, y)
        self.last_move_time = current_time

    def on_click(self, x, y, button, pressed):
        if pressed:
            if button == mouse.Button.left:
                self.click_count["left"] += 1
            elif button == mouse.Button.right:
                self.click_count["right"] += 1

    def calculate_1min_stats(self):
        """1åˆ†é–“ã®ãƒã‚¦ã‚¹å‹•ä½œçµ±è¨ˆã‚’è¨ˆç®—"""
        still_ratio = self.still_time / 60.0  # é™æ­¢æ™‚é–“ã®å‰²åˆ

        return {
            "movement_distance_px": self.total_distance,
            "click_frequency": sum(self.click_count.values()),
            "left_click_count": self.click_count["left"],
            "right_click_count": self.click_count["right"],
            "still_time_ratio": still_ratio,
            "timestamp": time.time()
        }

        # ã‚«ã‚¦ãƒ³ã‚¿ãƒªã‚»ãƒƒãƒˆ
        self.total_distance = 0
        self.click_count = {"left": 0, "right": 0, "double": 0}
```

---

### **3.3 ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åé›†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« (`window_collector.py`)**

#### **3.3.1 åé›†ãƒ‡ãƒ¼ã‚¿**

```python
{
    "timestamp": "2025-12-11T14:30:45.123",
    "active_window_hash": "a3f5b2c1...",  # ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åã®ãƒãƒƒã‚·ãƒ¥å€¤
    "work_category": "development"         # ä½œæ¥­ã‚«ãƒ†ã‚´ãƒª
}
```

#### **3.3.2 ä½œæ¥­ã‚«ãƒ†ã‚´ãƒªã®åˆ†é¡ãƒ«ãƒ¼ãƒ«**

```python
CATEGORY_RULES = {
    "development": ["Visual Studio Code", "PyCharm", "IntelliJ", "Xcode", "Terminal"],
    "communication": ["Slack", "Discord", "Teams", "Zoom", "Mail"],
    "browsing": ["Chrome", "Firefox", "Safari", "Edge"],
    "document": ["Word", "Excel", "PowerPoint", "Pages", "Numbers"],
    "other": []  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
}
```

#### **3.3.3 å®Ÿè£…ã‚³ãƒ¼ãƒ‰ä¾‹**

```python
import pygetwindow as gw
import hashlib

class WindowCollector:
    def __init__(self):
        self.window_switches = 0
        self.last_window = None

    def get_active_window(self):
        """ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®æƒ…å ±ã‚’å–å¾—"""
        try:
            active_window = gw.getActiveWindow()
            if active_window:
                window_title = active_window.title

                # ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·: ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚¿ã‚¤ãƒˆãƒ«ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–
                window_hash = hashlib.sha256(window_title.encode()).hexdigest()[:16]

                # ã‚«ãƒ†ã‚´ãƒªåˆ†é¡
                category = self.classify_category(window_title)

                # ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åˆ‡ã‚Šæ›¿ãˆæ¤œå‡º
                if self.last_window != window_hash:
                    self.window_switches += 1
                    self.last_window = window_hash

                return {
                    "window_hash": window_hash,
                    "work_category": category,
                    "timestamp": time.time()
                }
        except Exception as e:
            print(f"ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
            return None

    def classify_category(self, window_title):
        """ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ä½œæ¥­ã‚«ãƒ†ã‚´ãƒªã‚’åˆ†é¡"""
        for category, keywords in CATEGORY_RULES.items():
            if any(keyword.lower() in window_title.lower() for keyword in keywords):
                return category
        return "other"

    def get_1min_stats(self):
        """1åˆ†é–“ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦çµ±è¨ˆ"""
        stats = {
            "window_switch_count": self.window_switches,
            "timestamp": time.time()
        }
        self.window_switches = 0  # ãƒªã‚»ãƒƒãƒˆ
        return stats
```

---

### **3.4 ç’°å¢ƒãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« (`environment_collector.py`)**

#### **3.4.1 M5Stack ENV III Unit ã¨ã®é€šä¿¡**

```python
{
    "timestamp": "2025-12-11T14:30:45.123",
    "temperature": 24.5,    # å®¤æ¸©ï¼ˆâ„ƒï¼‰
    "humidity": 50.2,       # æ¹¿åº¦ï¼ˆ%ï¼‰
    "pressure": 1013.25     # æ°—åœ§ï¼ˆhPaï¼‰
}
```

#### **3.4.2 å®Ÿè£…ã‚³ãƒ¼ãƒ‰ä¾‹**

```python
import serial
import json

class EnvironmentCollector:
    def __init__(self, port="/dev/ttyUSB0", baudrate=115200):
        """
        M5Stack ENV III Unitã¨ã®ã‚·ãƒªã‚¢ãƒ«é€šä¿¡ã‚’åˆæœŸåŒ–
        port: ã‚·ãƒªã‚¢ãƒ«ãƒãƒ¼ãƒˆï¼ˆWindows: COM3, macOS: /dev/tty.usbserial-xxxï¼‰
        """
        try:
            self.serial = serial.Serial(port, baudrate, timeout=1)
        except Exception as e:
            print(f"M5Stackæ¥ç¶šã‚¨ãƒ©ãƒ¼: {e}")
            self.serial = None

    def read_sensor_data(self):
        """ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚Š"""
        if self.serial and self.serial.in_waiting > 0:
            try:
                line = self.serial.readline().decode('utf-8').strip()
                data = json.loads(line)

                return {
                    "temperature": data.get("temp", 0),
                    "humidity": data.get("humidity", 0),
                    "pressure": data.get("pressure", 0),
                    "timestamp": time.time()
                }
            except Exception as e:
                print(f"ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼: {e}")
                return None
        return None

    def close(self):
        if self.serial:
            self.serial.close()
```

#### **3.4.3 M5Stack å´ã® Arduino ã‚³ãƒ¼ãƒ‰ï¼ˆå‚è€ƒï¼‰**

```cpp
#include <M5StickC.h>
#include "Adafruit_Sensor.h"
#include <Adafruit_BMP280.h>
#include "SHT3X.h"

SHT3X sht30;
Adafruit_BMP280 bmp;

void setup() {
  M5.begin();
  Serial.begin(115200);

  Wire.begin(0, 26);
  bmp.begin(0x76);

  sht30.begin(0x44);
}

void loop() {
  if (sht30.get() == 0) {
    float temp = sht30.cTemp;
    float humidity = sht30.humidity;
    float pressure = bmp.readPressure() / 100.0;

    // JSONå½¢å¼ã§é€ä¿¡
    Serial.print("{\"temp\":");
    Serial.print(temp);
    Serial.print(",\"humidity\":");
    Serial.print(humidity);
    Serial.print(",\"pressure\":");
    Serial.print(pressure);
    Serial.println("}");
  }

  delay(10000);  // 10ç§’ã”ã¨
}
```

---

### **3.5 ãƒ‡ãƒ¼ã‚¿é›†ç´„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« (`data_aggregator.py`)**

ã™ã¹ã¦ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã—ã€çµ±ä¸€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ç®¡ç†ã™ã‚‹ã€‚

```python
class DataAggregator:
    def __init__(self):
        self.keystroke_collector = KeystrokeCollector()
        self.mouse_collector = MouseCollector()
        self.window_collector = WindowCollector()
        self.env_collector = EnvironmentCollector()

        self.keystroke_collector.start()
        self.mouse_collector.start()

    def collect_1min_data(self):
        """1åˆ†ã”ã¨ã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’é›†ç´„"""
        return {
            "keystroke": self.keystroke_collector.calculate_1min_stats(),
            "mouse": self.mouse_collector.calculate_1min_stats(),
            "window": self.window_collector.get_1min_stats(),
            "environment": self.env_collector.read_sensor_data(),
            "system_time": time.time()
        }
```

---

### **3.6 ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« (`data_storage.py`)**

#### **3.6.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ**

```sql
-- 1åˆ†ã”ã¨ã®é›†ç´„ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
CREATE TABLE training_data (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp REAL NOT NULL,

    -- ã‚­ãƒ¼ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿
    typing_speed_kpm INTEGER,
    avg_key_interval_ms REAL,
    std_key_interval_ms REAL,
    max_key_interval_ms REAL,
    min_key_interval_ms REAL,
    mistype_frequency INTEGER,

    -- ãƒã‚¦ã‚¹ãƒ‡ãƒ¼ã‚¿
    movement_distance_px REAL,
    click_frequency INTEGER,
    left_click_count INTEGER,
    right_click_count INTEGER,
    still_time_ratio REAL,

    -- ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ‡ãƒ¼ã‚¿
    window_hash TEXT,
    work_category TEXT,
    window_switch_count INTEGER,

    -- ç’°å¢ƒãƒ‡ãƒ¼ã‚¿
    temperature REAL,
    humidity REAL,
    pressure REAL,

    -- ãƒ©ãƒ™ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆPVTã‹ã‚‰è‡ªå‹•å–å¾—ï¼‰
    focus_score REAL,           -- é›†ä¸­åº¦ã‚¹ã‚³ã‚¢ï¼ˆ0.0~1.0ã€PVTã‹ã‚‰ï¼‰
    state_label TEXT            -- "Deep Focus", "Open", "Overheat"
);

-- PVTãƒ†ã‚¹ãƒˆçµæœãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ–°è¦è¿½åŠ ï¼‰
CREATE TABLE pvt_results (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp REAL NOT NULL,              -- ãƒ†ã‚¹ãƒˆå®Ÿæ–½æ™‚åˆ»
    stimulus_time REAL NOT NULL,          -- åˆºæ¿€æç¤ºæ™‚åˆ»
    reaction_time_ms REAL,                -- åå¿œæ™‚é–“ï¼ˆãƒŸãƒªç§’ã€NULL=åå¿œãªã—ï¼‰
    focus_score REAL,                     -- é›†ä¸­åº¦ã‚¹ã‚³ã‚¢ï¼ˆ0.0-1.0ï¼‰
    alertness_level TEXT,                 -- è¦šé†’åº¦ãƒ¬ãƒ™ãƒ«
    is_lapse BOOLEAN                      -- ãƒ©ãƒ—ã‚¹ï¼ˆ500msä»¥ä¸Šï¼‰ã‹ã©ã†ã‹
);

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«
CREATE TABLE user_profile (
    user_id TEXT PRIMARY KEY,
    age INTEGER,
    occupation TEXT,
    typing_skill TEXT,           -- "beginner", "intermediate", "expert"
    baseline_rt_median REAL,     -- å€‹äººãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³åå¿œæ™‚é–“ï¼ˆä¸­å¤®å€¤ï¼‰
    baseline_rt_std REAL,        -- å€‹äººãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³åå¿œæ™‚é–“ï¼ˆæ¨™æº–åå·®ï¼‰
    created_at REAL
);
```

#### **3.6.2 å®Ÿè£…ã‚³ãƒ¼ãƒ‰**

```python
import sqlite3
import json

class DataStorage:
    def __init__(self, db_path="zone_key_data.db"):
        self.conn = sqlite3.connect(db_path)
        self.cursor = self.conn.cursor()
        self.create_tables()

    def create_tables(self):
        """ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ"""
        self.cursor.execute("""
            CREATE TABLE IF NOT EXISTS training_data (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                timestamp REAL NOT NULL,
                typing_speed_kpm INTEGER,
                avg_key_interval_ms REAL,
                std_key_interval_ms REAL,
                max_key_interval_ms REAL,
                min_key_interval_ms REAL,
                mistype_frequency INTEGER,
                movement_distance_px REAL,
                click_frequency INTEGER,
                left_click_count INTEGER,
                right_click_count INTEGER,
                still_time_ratio REAL,
                window_hash TEXT,
                work_category TEXT,
                window_switch_count INTEGER,
                temperature REAL,
                humidity REAL,
                pressure REAL,
                focus_score REAL,
                fatigue_level INTEGER,
                state_label TEXT
            )
        """)
        self.conn.commit()

    def save_data(self, data):
        """é›†ç´„ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜"""
        keystroke = data.get("keystroke", {})
        mouse = data.get("mouse", {})
        window = data.get("window", {})
        environment = data.get("environment", {})

        self.cursor.execute("""
            INSERT INTO training_data (
                timestamp,
                typing_speed_kpm, avg_key_interval_ms, std_key_interval_ms,
                max_key_interval_ms, min_key_interval_ms, mistype_frequency,
                movement_distance_px, click_frequency, left_click_count,
                right_click_count, still_time_ratio,
                window_hash, work_category, window_switch_count,
                temperature, humidity, pressure
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        """, (
            data.get("system_time"),
            keystroke.get("typing_speed_kpm"),
            keystroke.get("avg_key_interval_ms"),
            keystroke.get("std_key_interval_ms"),
            keystroke.get("max_key_interval_ms"),
            keystroke.get("min_key_interval_ms"),
            keystroke.get("mistype_frequency"),
            mouse.get("movement_distance_px"),
            mouse.get("click_frequency"),
            mouse.get("left_click_count"),
            mouse.get("right_click_count"),
            mouse.get("still_time_ratio"),
            window.get("window_hash"),
            window.get("work_category"),
            window.get("window_switch_count"),
            environment.get("temperature"),
            environment.get("humidity"),
            environment.get("pressure")
        ))
        self.conn.commit()

    def export_to_csv(self, output_path="training_data.csv"):
        """å­¦ç¿’ç”¨ã«CSVå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ"""
        df = pd.read_sql_query("SELECT * FROM training_data", self.conn)
        df.to_csv(output_path, index=False)
        print(f"ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ: {output_path}")

    def close(self):
        self.conn.close()
```

---

## **4. ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚°ãƒ©ãƒ  (`main.py`)**

ã™ã¹ã¦ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’çµ±åˆã—ã€PVT ãƒ†ã‚¹ãƒˆã‚‚å«ã‚ã¦å‹•ä½œã•ã›ã‚‹ã€‚

```python
import time
import random
import threading
from data_aggregator import DataAggregator
from data_storage import DataStorage
from pvt_test import PVTTest

class ZoneKeyDataCollector:
    def __init__(self):
        self.aggregator = DataAggregator()
        self.storage = DataStorage()
        self.pvt = PVTTest()
        self.running = False

        # æ¬¡ã®PVTãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚åˆ»ï¼ˆ30-60åˆ†å¾Œï¼‰
        self.next_pvt_time = time.time() + random.uniform(30*60, 60*60)

    def collect_loop(self):
        """1åˆ†ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿åé›†"""
        while self.running:
            try:
                # é€šå¸¸ã®ãƒ‡ãƒ¼ã‚¿åé›†
                data = self.aggregator.collect_1min_data()
                self.storage.save_data(data)
                print(f"ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†: {time.strftime('%Y-%m-%d %H:%M:%S')}")

                # PVTãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œåˆ¤å®š
                if time.time() >= self.next_pvt_time:
                    print("\n" + "="*50)
                    print("ğŸ”´ PVTãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™ï¼ˆé›†ä¸­åº¦æ¸¬å®šï¼‰")
                    print("="*50)
                    self.run_pvt_test()

                    # æ¬¡ã®ãƒ†ã‚¹ãƒˆæ™‚åˆ»ã‚’è¨­å®šï¼ˆ30-60åˆ†å¾Œã€ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
                    self.next_pvt_time = time.time() + random.uniform(30*60, 60*60)
                    print(f"æ¬¡ã®PVTãƒ†ã‚¹ãƒˆ: {time.strftime('%H:%M:%S', time.localtime(self.next_pvt_time))}")

            except Exception as e:
                print(f"ã‚¨ãƒ©ãƒ¼: {e}")

            time.sleep(60)  # 1åˆ†å¾…æ©Ÿ

    def run_pvt_test(self):
        """PVTãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œï¼‰"""
        self.pvt.show_test()

    def start(self):
        """ãƒ‡ãƒ¼ã‚¿åé›†é–‹å§‹"""
        self.running = True
        print("="*60)
        print("Zone Key ãƒ‡ãƒ¼ã‚¿åé›†ãƒ—ãƒ­ã‚°ãƒ©ãƒ ")
        print("="*60)
        print("ãƒ‡ãƒ¼ã‚¿åé›†ã‚’é–‹å§‹ã—ã¾ã™...")
        print(f"æ¬¡ã®PVTãƒ†ã‚¹ãƒˆ: {time.strftime('%H:%M:%S', time.localtime(self.next_pvt_time))}")
        print("\nâ€» PVTãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­ã¯ä½œæ¥­ã‚’ä¸­æ–­ã—ã€ãƒ†ã‚¹ãƒˆã«é›†ä¸­ã—ã¦ãã ã•ã„")
        print("  ESCã‚­ãƒ¼ã§ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã§ãã¾ã™\n")

        # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œ
        thread = threading.Thread(target=self.collect_loop, daemon=True)
        thread.start()

        try:
            while True:
                time.sleep(1)
        except KeyboardInterrupt:
            print("\n\nãƒ‡ãƒ¼ã‚¿åé›†ã‚’åœæ­¢ã—ã¾ã™...")
            self.stop()

    def stop(self):
        """ãƒ‡ãƒ¼ã‚¿åé›†åœæ­¢"""
        self.running = False
        self.storage.close()
        self.pvt.close_db()
        print("ãƒ‡ãƒ¼ã‚¿åé›†ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚")

if __name__ == "__main__":
    collector = ZoneKeyDataCollector()
    collector.start()
```

**å®Ÿè¡Œæ–¹æ³•:**

```bash
# ç®¡ç†è€…æ¨©é™ã§å®Ÿè¡Œï¼ˆã‚­ãƒ¼ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯å–å¾—ã®ãŸã‚ï¼‰
sudo python main.py  # macOS/Linux
# ã¾ãŸã¯
# å³ã‚¯ãƒªãƒƒã‚¯ â†’ ç®¡ç†è€…ã¨ã—ã¦å®Ÿè¡Œ  # Windows
```

---

## **5. PVTï¼ˆç²¾ç¥é‹å‹•è­¦æˆ’æ¤œæŸ»ï¼‰ã«ã‚ˆã‚‹é›†ä¸­åº¦æ¸¬å®š**

**é‡è¦**: æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€é›†ä¸­åº¦ã®æ¸¬å®šã«**PVTï¼ˆPsychomotor Vigilance Testï¼‰**ã‚’æ¡ç”¨ã—ã¾ã™ã€‚ã“ã‚Œã¯ NASA ã‚„ç±³è»ã§ã‚‚ä½¿ç”¨ã•ã‚Œã‚‹åŒ»å­¦çš„ã«å®Ÿè¨¼ã•ã‚ŒãŸæ‰‹æ³•ã§ã™ã€‚

### **5.1 PVT ã¨ã¯**

ç”»é¢ã«è¡¨ç¤ºã•ã‚ŒãŸè¦–è¦šåˆºæ¿€ï¼ˆğŸ”´ï¼‰ã«å¯¾ã™ã‚‹**åå¿œæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰**ã‚’æ¸¬å®šã™ã‚‹ã“ã¨ã§ã€è¦šé†’åº¦ãƒ»é›†ä¸­åº¦ã‚’å®¢è¦³çš„ã«è©•ä¾¡ã—ã¾ã™ã€‚

| åå¿œæ™‚é–“   | é›†ä¸­åº¦ã‚¹ã‚³ã‚¢ | åˆ¤å®š       |
| :--------- | :----------- | :--------- |
| 150-250ms  | 0.9-1.0      | Deep Focus |
| 250-350ms  | 0.7-0.9      | Focused    |
| 350-500ms  | 0.5-0.7      | Open       |
| 500-700ms  | 0.3-0.5      | Distracted |
| 700ms ä»¥ä¸Š | 0.0-0.3      | Overheat   |

### **5.2 PVT å®Ÿè£…ï¼ˆ`pvt_test.py`ï¼‰**

è©³ç´°ã¯ã€Œ**é›†ä¸­åº¦æ¸¬å®šæ–¹æ³•ã®è©³ç´°è¨­è¨ˆ.md**ã€ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

ç°¡æ˜“ç‰ˆã®å®Ÿè£…ä¾‹ï¼š

```python
import tkinter as tk
import time
import random
import sqlite3

class PVTTest:
    """PVTï¼ˆç²¾ç¥é‹å‹•è­¦æˆ’æ¤œæŸ»ï¼‰ãƒ†ã‚¹ãƒˆ"""

    def __init__(self, db_path="zone_key_data.db"):
        self.db = sqlite3.connect(db_path)
        self.cursor = self.db.cursor()
        self.create_table()

        self.window = None
        self.stimulus_time = None
        self.reaction_time = None

    def create_table(self):
        """PVTãƒ†ã‚¹ãƒˆçµæœã‚’ä¿å­˜ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ"""
        self.cursor.execute("""
            CREATE TABLE IF NOT EXISTS pvt_results (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                timestamp REAL NOT NULL,
                stimulus_time REAL NOT NULL,
                reaction_time_ms REAL,
                focus_score REAL,
                alertness_level TEXT,
                is_lapse BOOLEAN
            )
        """)
        self.db.commit()

    def show_test(self):
        """PVTãƒ†ã‚¹ãƒˆã‚’è¡¨ç¤º"""
        # å°ã•ãªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ä½œæˆï¼ˆ400x300ã€ç”»é¢ä¸­å¤®ï¼‰
        self.window = tk.Tk()
        self.window.title("PVT ãƒ†ã‚¹ãƒˆ")

        window_width = 400
        window_height = 300
        screen_width = self.window.winfo_screenwidth()
        screen_height = self.window.winfo_screenheight()
        x = (screen_width - window_width) // 2
        y = (screen_height - window_height) // 2

        self.window.geometry(f"{window_width}x{window_height}+{x}+{y}")
        self.window.configure(bg='black')

        # æœ€å‰é¢ã«è¡¨ç¤º
        self.window.attributes('-topmost', True)
        self.window.lift()
        self.window.focus_force()

        # æŒ‡ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        instruction = tk.Label(
            self.window,
            text="ğŸ”´ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰\nã§ãã‚‹ã ã‘æ—©ã\nã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ãã ã•ã„",
            font=("Arial", 16),
            fg="white",
            bg="black"
        )
        instruction.pack(expand=True)

        # çŸ­ã„é…å»¶ï¼ˆ0.5-1.5ç§’ï¼‰å¾Œã«åˆºæ¿€ã‚’è¡¨ç¤º
        delay = random.uniform(500, 1500)
        self.window.after(int(delay), lambda: self.show_stimulus(instruction))

        # ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ã®åå¿œã‚’å¾…ã¤
        self.window.bind('<space>', self.on_response)
        self.window.bind('<Escape>', lambda e: self.close_test())

        self.window.mainloop()

    def show_stimulus(self, instruction_label):
        """è¦–è¦šåˆºæ¿€ï¼ˆèµ¤ã„å††ï¼‰ã‚’è¡¨ç¤º"""
        instruction_label.destroy()

        # åˆºæ¿€è¡¨ç¤ºæ™‚åˆ»ã‚’è¨˜éŒ²
        self.stimulus_time = time.time()

        # èµ¤ã„å††ã‚’è¡¨ç¤º
        canvas = tk.Canvas(self.window, width=200, height=200,
                          bg='black', highlightthickness=0)
        canvas.pack(expand=True)
        canvas.create_oval(10, 10, 190, 190, fill='red')

        # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ2ç§’ï¼‰
        self.window.after(2000, self.on_timeout)

    def on_response(self, event):
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åå¿œã‚’è¨˜éŒ²"""
        if self.stimulus_time is None:
            return  # åˆºæ¿€å‰ã®æŠ¼ä¸‹ã¯ç„¡è¦–

        response_time = time.time()
        self.reaction_time = (response_time - self.stimulus_time) * 1000

        # çµæœã‚’ä¿å­˜
        focus_score = self.calculate_focus_score(self.reaction_time)
        self.save_result(self.reaction_time, focus_score)

        # çµæœã‚’è¡¨ç¤º
        alertness_level = self.get_alertness_level(self.reaction_time)
        result_text = f"åå¿œæ™‚é–“: {self.reaction_time:.0f}ms\n\n"
        result_text += f"è¦šé†’åº¦: {alertness_level}\n"
        result_text += f"é›†ä¸­åº¦ã‚¹ã‚³ã‚¢: {focus_score:.2f}"

        self.show_result(result_text)

    def on_timeout(self):
        """ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆåå¿œãªã—ï¼‰"""
        if self.reaction_time is None:
            self.save_result(None, 0.0)
            self.show_result("åå¿œãªã—ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰\n\nè¦šé†’åº¦: éå¸¸ã«ä½ã„")

    def calculate_focus_score(self, rt_ms):
        """åå¿œæ™‚é–“ã‹ã‚‰é›†ä¸­åº¦ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ï¼ˆ0.0-1.0ï¼‰"""
        if rt_ms is None:
            return 0.0
        elif rt_ms < 250:
            return 0.9 + (250 - rt_ms) / 1000
        elif rt_ms < 350:
            return 0.7 + (350 - rt_ms) / 500
        elif rt_ms < 500:
            return 0.5 + (500 - rt_ms) / 750
        elif rt_ms < 700:
            return 0.3 + (700 - rt_ms) / 1000
        else:
            return max(0.0, 0.3 - (rt_ms - 700) / 2000)

    def get_alertness_level(self, rt_ms):
        """è¦šé†’åº¦ãƒ¬ãƒ™ãƒ«ã®åˆ¤å®š"""
        if rt_ms is None:
            return "éå¸¸ã«ä½ã„"
        elif rt_ms < 250:
            return "éå¸¸ã«é«˜ã„"
        elif rt_ms < 350:
            return "é«˜ã„"
        elif rt_ms < 500:
            return "é€šå¸¸"
        elif rt_ms < 700:
            return "ä½ã„"
        else:
            return "éå¸¸ã«ä½ã„"

    def save_result(self, rt_ms, focus_score):
        """çµæœã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜"""
        alertness_level = self.get_alertness_level(rt_ms)
        is_lapse = (rt_ms is None or rt_ms > 500)

        self.cursor.execute("""
            INSERT INTO pvt_results (
                timestamp, stimulus_time, reaction_time_ms,
                focus_score, alertness_level, is_lapse
            ) VALUES (?, ?, ?, ?, ?, ?)
        """, (
            time.time(),
            self.stimulus_time or 0,
            rt_ms,
            focus_score,
            alertness_level,
            is_lapse
        ))
        self.db.commit()

        # training_dataã«é›†ä¸­åº¦ã‚¹ã‚³ã‚¢ã‚’è¨˜éŒ²
        self.cursor.execute("""
            UPDATE training_data
            SET focus_score = ?,
                state_label = ?
            WHERE id = (SELECT MAX(id) FROM training_data)
        """, (
            focus_score,
            "Deep Focus" if focus_score > 0.7 else
            "Open" if focus_score >= 0.3 else
            "Overheat"
        ))
        self.db.commit()

    def show_result(self, text):
        """çµæœã‚’è¡¨ç¤º"""
        for widget in self.window.winfo_children():
            widget.destroy()

        result_label = tk.Label(
            self.window,
            text=text,
            font=("Arial", 28, "bold"),
            fg="lime",
            bg="black"
        )
        result_label.pack(expand=True)

        # 3ç§’å¾Œã«è‡ªå‹•çš„ã«é–‰ã˜ã‚‹
        self.window.after(3000, self.close_test)

    def close_test(self):
        """ãƒ†ã‚¹ãƒˆã‚’é–‰ã˜ã‚‹"""
        if self.window:
            try:
                self.window.quit()  # mainloopã‚’çµ‚äº†
                self.window.destroy()  # ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ç ´æ£„
            except:
                pass
            self.window = None

    def close_db(self):
        """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’é–‰ã˜ã‚‹"""
        self.db.close()

if __name__ == "__main__":
    pvt = PVTTest()
    pvt.show_test()
    pvt.close_db()
```

è©³ç´°ãªå®Ÿè£…ã¯ã€Œ**é›†ä¸­åº¦æ¸¬å®šæ–¹æ³•ã®è©³ç´°è¨­è¨ˆ.md**ã€ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

---

## **6. ãƒ‡ãƒ¼ã‚¿åé›†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«**

### **6.1 Phase 1: åˆæœŸãƒ‡ãƒ¼ã‚¿åé›†ï¼ˆ2 é€±é–“ï¼‰**

| æ—¥ç¨‹       | åé›†å†…å®¹                                                                              | ç›®æ¨™ãƒ‡ãƒ¼ã‚¿é‡                   |
| :--------- | :------------------------------------------------------------------------------------ | :----------------------------- |
| **1 é€±ç›®** | - ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å‹•ä½œç¢ºèª<br>- 5 åã®ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ãŒä½¿ç”¨<br>- 5 åˆ†ã”ã¨ã« PVT ãƒ†ã‚¹ãƒˆå®Ÿæ–½ | 200 æ™‚é–“åˆ†ï¼ˆPVT: 2400 å›ä»¥ä¸Šï¼‰ |
| **2 é€±ç›®** | - ç¶™ç¶šçš„ãªãƒ‡ãƒ¼ã‚¿åé›†<br>- PVT ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®è“„ç©<br>- ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®è¨˜éŒ²              | 200 æ™‚é–“åˆ†ï¼ˆPVT: 2400 å›ä»¥ä¸Šï¼‰ |

**ç›®æ¨™**: å„äºº 1 æ—¥ 96 å›ã® PVT ãƒ†ã‚¹ãƒˆï¼ˆ8 æ™‚é–“ Ã— 12 å›/æ™‚ï¼‰Ã— 10 æ—¥ = **è¨ˆ 4800 å›ä»¥ä¸Šã® PVT ãƒ‡ãƒ¼ã‚¿**

### **6.2 ãƒ‡ãƒ¼ã‚¿å“è³ªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ**

- [ ] ã‚­ãƒ¼ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] ãƒã‚¦ã‚¹å‹•ä½œãƒ‡ãƒ¼ã‚¿ã«æ¬ æãŒãªã„ã‹
- [ ] ç’°å¢ƒã‚»ãƒ³ã‚µãƒ¼ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã‹
- [ ] **PVT ãƒ†ã‚¹ãƒˆãŒ 5 åˆ†é–“éš”ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹**
- [ ] **PVT åå¿œæ™‚é–“ãŒé©åˆ‡ãªç¯„å›²ï¼ˆ150-1000msï¼‰ã«åã¾ã£ã¦ã„ã‚‹ã‹**
- [ ] ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ï¼ˆã‚­ãƒ¼å†…å®¹ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ãªã„ã‹ï¼‰

---

## **7. ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·å¯¾ç­–**

### **7.1 å®Ÿè£…æ¸ˆã¿å¯¾ç­–**

1. **ã‚­ãƒ¼å†…å®¹ã‚’è¨˜éŒ²ã—ãªã„**

   - æ‰“éµã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°æƒ…å ±ã®ã¿è¨˜éŒ²
   - æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚„æ–‡å­—åˆ—ã¯ä¸€åˆ‡å–å¾—ã—ãªã„

2. **ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åã®ãƒãƒƒã‚·ãƒ¥åŒ–**

   - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’ SHA-256 ã§ãƒãƒƒã‚·ãƒ¥åŒ–
   - å…ƒã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å¾©å…ƒä¸å¯èƒ½

3. **ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**

   - ãƒ‡ãƒ¼ã‚¿ã¯å…¨ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜
   - ã‚¯ãƒ©ã‚¦ãƒ‰é€ä¿¡ã¯åŒ¿ååŒ–å¾Œã®ã¿

4. **ãƒ¦ãƒ¼ã‚¶ãƒ¼åŒæ„**
   - ãƒ—ãƒ­ã‚°ãƒ©ãƒ èµ·å‹•æ™‚ã«åˆ©ç”¨è¦ç´„ã‚’è¡¨ç¤º
   - ãƒ‡ãƒ¼ã‚¿åé›†ã®ç›®çš„ã‚’æ˜ç¤º

---

## **8. ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½**

### **8.1 å­¦ç¿’ç”¨ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ç”Ÿæˆï¼ˆPVT ãƒ‡ãƒ¼ã‚¿çµ±åˆç‰ˆï¼‰**

```python
def export_training_dataset_with_pvt(db_path="zone_key_data.db",
                                     output_path="dataset_pvt.csv"):
    """PVTãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚€å­¦ç¿’ç”¨ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ"""
    conn = sqlite3.connect(db_path)

    # PVTçµæœã¨training_dataã‚’çµåˆ
    query = """
        SELECT
            t.timestamp,

            -- ã‚­ãƒ¼ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿
            t.typing_speed_kpm,
            t.avg_key_interval_ms,
            t.std_key_interval_ms,
            t.mistype_frequency,

            -- ãƒã‚¦ã‚¹ãƒ‡ãƒ¼ã‚¿
            t.movement_distance_px,
            t.click_frequency,

            -- ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ‡ãƒ¼ã‚¿
            t.work_category,
            t.window_switch_count,

            -- ç’°å¢ƒãƒ‡ãƒ¼ã‚¿
            t.temperature,
            t.humidity,
            t.pressure,

            -- PVTãƒ‡ãƒ¼ã‚¿ï¼ˆç›´è¿‘ã®ãƒ†ã‚¹ãƒˆçµæœï¼‰
            p.reaction_time_ms AS pvt_rt,
            p.focus_score AS pvt_focus_score,
            p.alertness_level,
            p.is_lapse AS pvt_lapse,

            -- ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå¤‰æ•°ï¼ˆPVTã‹ã‚‰å–å¾—ï¼‰
            p.focus_score AS target_focus_score,
            CASE
                WHEN p.focus_score > 0.7 THEN 'Deep Focus'
                WHEN p.focus_score >= 0.3 THEN 'Open'
                ELSE 'Overheat'
            END AS target_state

        FROM training_data t
        LEFT JOIN (
            SELECT
                *,
                ROW_NUMBER() OVER (
                    PARTITION BY CAST(timestamp / 3600 AS INTEGER)
                    ORDER BY timestamp DESC
                ) as rn
            FROM pvt_results
            WHERE reaction_time_ms IS NOT NULL
        ) p ON p.rn = 1
        WHERE p.reaction_time_ms IS NOT NULL
        ORDER BY t.timestamp
    """

    df = pd.read_sql_query(query, conn)

    # ä½œæ¥­ã‚«ãƒ†ã‚´ãƒªã®One-Hot Encoding
    df = pd.get_dummies(df, columns=['work_category'])

    # æ™‚åˆ»ã®Cyclical Encoding
    df['hour_sin'] = np.sin(2 * np.pi * df['timestamp'].apply(
        lambda x: datetime.fromtimestamp(x).hour) / 24)
    df['hour_cos'] = np.cos(2 * np.pi * df['timestamp'].apply(
        lambda x: datetime.fromtimestamp(x).hour) / 24)

    df.to_csv(output_path, index=False)
    conn.close()

    print(f"âœ… PVTãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç”Ÿæˆå®Œäº†: {output_path}")
    print(f"   ç·ã‚µãƒ³ãƒ—ãƒ«æ•°: {len(df)}")
    print(f"   ç‰¹å¾´é‡æ•°: {len(df.columns) - 2}")
    print("\nã€é›†ä¸­åº¦ã‚¹ã‚³ã‚¢ã®åˆ†å¸ƒã€‘")
    print(df['target_focus_score'].describe())
    print("\nã€çŠ¶æ…‹ãƒ©ãƒ™ãƒ«ã®åˆ†å¸ƒã€‘")
    print(df['target_state'].value_counts())
```

---

## **9. å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ**

### **Phase 1: MVPï¼ˆæœ€å°æ©Ÿèƒ½ï¼‰**

- [ ] `keystroke_collector.py` ã®å®Ÿè£…
- [ ] `mouse_collector.py` ã®å®Ÿè£…
- [ ] `window_collector.py` ã®å®Ÿè£…
- [ ] `data_storage.py` ã®å®Ÿè£…
- [ ] `main.py` ã®å®Ÿè£…
- [ ] å‹•ä½œç¢ºèªï¼ˆ1 æ™‚é–“ã®ãƒ†ã‚¹ãƒˆåé›†ï¼‰

### **Phase 2: ç’°å¢ƒãƒ‡ãƒ¼ã‚¿çµ±åˆ**

- [ ] M5Stack ENV III Unit ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
- [ ] `environment_collector.py` ã®å®Ÿè£…
- [ ] ã‚·ãƒªã‚¢ãƒ«é€šä¿¡ã®å‹•ä½œç¢ºèª

### **Phase 3: PVT ãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ **

- [ ] `pvt_test.py` ã®å®Ÿè£…
- [ ] PVT GUI å‹•ä½œç¢ºèªï¼ˆãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤ºã€åå¿œæ™‚é–“æ¸¬å®šï¼‰
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é€£æºã®ç¢ºèª
- [ ] æŠœãæ‰“ã¡ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ã®å®Ÿè£…

### **Phase 4: ãƒ‡ãƒ¼ã‚¿åé›†é–‹å§‹**

- [ ] 5 åã®ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã«é…å¸ƒ
- [ ] 2 é€±é–“ã®ç¶™ç¶šçš„ãªãƒ‡ãƒ¼ã‚¿åé›†
- [ ] ãƒ‡ãƒ¼ã‚¿å“è³ªãƒã‚§ãƒƒã‚¯

---

## **10. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**

### **10.1 ã‚ˆãã‚ã‚‹å•é¡Œ**

| å•é¡Œ                             | åŸå›                          | è§£æ±ºç­–                                             |
| :------------------------------- | :--------------------------- | :------------------------------------------------- |
| **ã‚­ãƒ¼ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ãŒå–å¾—ã§ããªã„** | ç®¡ç†è€…æ¨©é™ãŒå¿…è¦             | ç®¡ç†è€…æ¨©é™ã§ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œ                       |
| **M5Stack ãŒæ¥ç¶šã§ããªã„**       | ã‚·ãƒªã‚¢ãƒ«ãƒãƒ¼ãƒˆãŒé–“é•ã£ã¦ã„ã‚‹ | ãƒ‡ãƒã‚¤ã‚¹ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§æ­£ã—ã„ãƒãƒ¼ãƒˆã‚’ç¢ºèª           |
| **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹**   | è¤‡æ•°ãƒ—ãƒ­ã‚»ã‚¹ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹     | `sqlite3.connect`ã«`check_same_thread=False`ã‚’æŒ‡å®š |
| **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒå¤šã„**           | éå»ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã—ã™ã       | `deque(maxlen=N)`ã§ãƒãƒƒãƒ•ã‚¡ã‚µã‚¤ã‚ºã‚’åˆ¶é™            |

---

## **11. ä»Šå¾Œã®æ‹¡å¼µæ©Ÿèƒ½**

1. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¯è¦–åŒ–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰**

   - PVT åå¿œæ™‚é–“ã®çµŒæ™‚å¤‰åŒ–ã‚°ãƒ©ãƒ•
   - é›†ä¸­åº¦ã‚¹ã‚³ã‚¢ã®æ¨ç§»ã‚’ç¢ºèª
   - ç–²åŠ´æŒ‡æ¨™ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º

2. **é©å¿œçš„ PVT å®Ÿè¡Œé–“éš”**

   - ç–²åŠ´ãŒè“„ç©ã—ãŸã‚‰è‡ªå‹•çš„ã«ãƒ†ã‚¹ãƒˆé »åº¦ã‚’ä¸Šã’ã‚‹
   - é›†ä¸­çŠ¶æ…‹ãŒç¶šã„ã¦ã„ã‚‹å ´åˆã¯ãƒ†ã‚¹ãƒˆé–“éš”ã‚’å»¶ã°ã™

3. **ãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œ**

   - è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†
   - å€‹äººãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã®è‡ªå‹•è¨ˆç®—
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ ID ã«ã‚ˆã‚‹åˆ†é›¢

4. **ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ**

   - åŒ¿ååŒ–å¾Œã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«é€ä¿¡
   - ãƒãƒ¼ãƒ å…¨ä½“ã®ãƒ‡ãƒ¼ã‚¿åé›†
   - é›†å›£ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã®æ§‹ç¯‰

---

## **12. å‚è€ƒè³‡æ–™**

### **ãƒ‡ãƒ¼ã‚¿åé›†é–¢é€£**

- pynput å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: https://pynput.readthedocs.io/
- M5Stack å…¬å¼ã‚µã‚¤ãƒˆ: https://m5stack.com/
- SQLite å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: https://www.sqlite.org/docs.html

### **PVTï¼ˆç²¾ç¥é‹å‹•è­¦æˆ’æ¤œæŸ»ï¼‰é–¢é€£**

- **Dinges, D. F., & Powell, J. W. (1985).** "Microcomputer analyses of performance on a portable, simple visual RT task during sustained operations." _Behavior Research Methods._
- **Basner, M., & Dinges, D. F. (2011).** "Maximizing Sensitivity of the Psychomotor Vigilance Test (PVT) to Sleep Loss." _Sleep._
- **NASA Human Research Program**: PVT ã‚’å®‡å®™é£›è¡Œå£«ã®ç–²åŠ´æ¸¬å®šã«ä½¿ç”¨
- **ç±³å›½é˜²ç·çœ**: å…µå£«ã®è¦šé†’åº¦ç®¡ç†ã« PVT ã‚’æ¡ç”¨

### **é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**

- **é›†ä¸­åº¦æ¸¬å®šæ–¹æ³•ã®è©³ç´°è¨­è¨ˆ.md**: PVT ã®è©³ç´°ãªå®Ÿè£…ã¨ç§‘å­¦çš„æ ¹æ‹ 
